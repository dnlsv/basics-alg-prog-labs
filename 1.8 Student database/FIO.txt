#include <iostream>
#include <fstream>
#include <string>
#include <stdio.h>
#include <cstdio>
#include <io.h>

struct Student
{
	char FIO[30];
	int year;
	int numgr;
	int balls[3];
	double srball;
}temp;

using namespace std;

Student *arr;
 FILE *fst, *ftxt;
int siz = sizeof(Student);

const char WAYDAT[] = "D://C++/File.dat";
const char WAYTXT[] = "D://C++/File.txt";
const char WAYSPISOK[] = "D://C++/Spisok.txt";

void Out(Student, FILE*);
void view(Student);
void begin(int&, int&);
void end(int&);

void inputNumber(int&);
bool isNumberNumeric();

void main()
{
	setlocale(LC_ALL, "rus");

	Student newst;
	FILE *fspis;
	int kod = 0, point, kol, i, numst, dan;
	double fiz, mat, inf, him, sr, pr;
	long len;

	//fopen_s(&ftxt, WAYTXT, "w");
	while (1)
	{
		puts("Выберите: \n1 - Создание\n2 - Коррекция\n3 - Просмотр\n4 - Индивидуальное задание\n0 - Выход");
		//scanf_s("%d", &kod);
		inputNumber(kod);
		switch (kod)
		{
		case 1: //Создание
			fopen_s(&fst, WAYDAT, "wb");
			if (fst == NULL) {
				puts("\nError!");
				return;
			}
			fclose(fst);
			puts("Create new file\n");
			break;
		case 2: //Коррекция
			puts("\nВыберите: \n1 - Добавление\n2 - Редактирование\n3 - Удаление\n0 - Вернуться");
			//scanf_s("%d", &point);
			inputNumber(point);
			switch (point)
			{
			case 1: //Добавление
				fopen_s(&fst, WAYDAT, "ab");
				printf_s("\nВведите:\n-Фамилию и инициалы:\n");
				//fflush(stdin);
				while (getchar() != '\n');
				gets_s(temp.FIO);
				printf_s("-Год рождения(от 1873 до 2018):\n");
				scanf_s("%d", &temp.year);
				//inputNumber(temp.year);
				printf("-Номер группы(6-ти значное значение):\n");
				scanf_s("%d", &temp.numgr);
				printf_s("-Оценки за семестр : по физике, математике, информатике, химии(от 0 до 10):\n");
				scanf_s("%d %d %d %d", &temp.balls[0], &temp.balls[1], &temp.balls[2], &temp.balls[3]);
				printf_s("\n");
				fiz = temp.balls[0];
				mat = temp.balls[1];
				inf = temp.balls[2];
				him = temp.balls[3];
				temp.srball = (fiz + mat + inf + him) / 4;
				fwrite(&temp, siz, 1, fst);
				fclose(fst);
				break;
			case 2: //Редактирование
				begin(numst, kol);

				printf("\nКакие данные Вы хотите изменить:\n1 - Фамилию и инициалы\n2 - Год рождения\n3 - Номер группы\n4 - Оценки за семестр\n");
				//scanf_s("%d", &dan);
				inputNumber(dan);
				printf_s("\nВведите новые данные:\n");
				switch (dan)
				{
				case 1: //Фамилию и инициалы 
					printf_s("\n-Фамилию и инициалы:\n");
					while (getchar() != '\n');
					gets_s(newst.FIO);
					strcpy_s(arr[numst - 1].FIO, newst.FIO);
					//arr[numst - 1].FIO = newst.FIO;
					break;
				case 2: //Год рождения
					printf_s("-Год рождения(от 1873 до 2018):\n");
					scanf_s("%d", &newst.year);
					arr[numst - 1].year = newst.year;
					break;
				case 3: //Номер группы
					printf("-Номер группы(6-ти значное значение):\n");
					scanf_s("%d", &newst.numgr);
					arr[numst - 1].numgr = newst.numgr;
					break;
				case 4: //Оценки за семестр
					printf_s("-Оценки за семестр : по физике, математике, информатике, химии(от 0 до 10):\n");
					scanf_s("%d %d %d %d", &newst.balls[0], &newst.balls[1], &newst.balls[2], &newst.balls[3]);
					arr[numst - 1].balls[0] = newst.balls[0];
					arr[numst - 1].balls[1] = newst.balls[1];
					arr[numst - 1].balls[2] = newst.balls[2];
					arr[numst - 1].balls[3] = newst.balls[3];
					fiz = newst.balls[0]; mat = newst.balls[1]; inf = newst.balls[2]; him = newst.balls[3];
					newst.srball = (fiz + mat + inf + him) / 4;
					arr[numst - 1].srball = newst.srball;
					break;
				default:
					puts("Некорректный ввод!\n");
				}
				//arr[numst - 1] = newst;
				end(kol);
				break;
			case 3: //Удаление
				begin(numst, kol);
				for (int i = numst - 1; i < kol - 1; i++)
					arr[i] = arr[i + 1]; 
				kol--;
				end(kol);
				break;
			case 0: //Вернуться
				break;
			default:
				puts("Некорректный ввод!\n");
			}

			break;
		case 3: //Просмотр
			view(temp);
			break;
		case 4: //Индивидуальное задание
			fopen_s(&fst, WAYDAT, "rb");
			len = _filelength(_fileno(fst));
			kol = len / siz;
			arr = new Student[kol];
			for (i = 0; i < kol; i++) {
				fread((arr + i), siz, 1, fst);
			}
			fclose(fst);

			sr = 0;
			for (int i = 0; i < kol; i++) {
				pr = arr[i].srball / kol;
				sr = sr + pr;
			}
			printf_s("\nОбщий средний балл - %f\n", sr);

			fopen_s(&fspis, WAYSPISOK, "w");
			for (int i = 0; i < kol; i++)
			{
				if (arr[i].srball > sr)
					fprintf(fspis, "%s\n", arr[i].FIO);
			}
			fclose(fspis);
			printf_s("\nТекстовый файл со списком студентов, средний балл которых выше среднего создан по пути - D://C++/Spisok.txt\n");
			break;
		case 0: //Выход
			//fclose(ftxt);
			return;
		default: 
			puts("Некорректный ввод!\n");
		}
	}
}

void view(Student t)
{
	int number = 0;
	if ((fopen_s(&fst, WAYDAT, "rb")) != NULL) {
		puts("\nError!");
		return;
	}
	fopen_s(&ftxt, WAYTXT, "w");//TXT
	printf_s("\n\tСписок студентов:\n");
	fprintf(ftxt, "Список студентов:\n");
	while (1) {
		if (fread(&t, siz, 1, fst) == 0) break;
		number++;
		printf_s("№%d\n", number);
		Out(t, ftxt);
	}
	fclose(ftxt);//TXT
	fclose(fst);
}

void begin(int &numst, int &kol)
{
	long len;
	view(temp);
	printf("Введите номер студента\n");
	//scanf_s("%d", &numst);
	inputNumber(numst);

	fopen_s(&fst, WAYDAT, "rb");
	len = _filelength(_fileno(fst));
	kol = len / siz;
	arr = new Student[kol];
	for (int i = 0; i < kol; i++) {
		fread((arr + i), siz, 1, fst);
	}
	fclose(fst);
}

void end(int &kol)
{
	printf_s("\n\tИзмененный список студентов:\n");
	fopen_s(&ftxt, WAYTXT, "w");//TXT
	for (int i = 0; i < kol; i++) {
		printf_s("№%d\n", i + 1);
		Out(arr[i], ftxt);
	}
	fopen_s(&fst, WAYDAT, "wb");
	for (int i = 0; i < kol; i++)
		fwrite(&arr[i], siz, 1, fst);
	fclose(fst);
	fclose(ftxt);//TXT
	delete[]arr;
}

void Out(Student t, FILE *ftxt)
{
	printf_s("%s ", t.FIO);
	printf_s("\nГод рождения - %d\nГруппа - %d", t.year, t.numgr);
	printf_s("\nОценки:\nФизика - %d Математика - %d Информатика - %d Химия - %d", t.balls[0], t.balls[1], t.balls[2], t.balls[3]);
	printf_s("\nСредний балл - %.1f", t.srball);
	puts("\n");

	fprintf(ftxt, "%s ", t.FIO);
	fprintf(ftxt, "\nГод рождения - %d\nГруппа - %d", t.year, t.numgr);
	fprintf(ftxt, "\nОценки:\nФизика - %d Математика - %d Информатика - %d Химия - %d", t.balls[0], t.balls[1], t.balls[2], t.balls[3]);
	fprintf(ftxt, "\nСредний балл - %.1f", t.srball);
	fprintf(ftxt, "\n\n");
}

void inputNumber(int &num)
{
	while (true)
	{
		cin >> num;
		if (isNumberNumeric())
			break;
		else
			cout << "Некорректный ввод!" << endl;
	}
}

bool isNumberNumeric()
{
	if (cin.get() == '\n') return true;
	else
	{
		cin.clear();
		cin.ignore(numeric_limits<streamsize>::max(), '\n');
		return false;
	}
}

/*printf_s("\nВведите новые данные:\n-Фамилию и инициалы:\n");
		while (getchar() != '\n');
		gets_s(newst.FIO);
		printf_s("-Год рождения(от 1873 до 2018):\n");
		scanf_s("%d", &newst.year);
		printf("-Номер группы(6-ти значное значение):\n");
		scanf_s("%d", &newst.numgr);
		printf_s("-Оценки за семестр : по физике, математике, информатике, химии(от 0 до 10):\n");
		scanf_s("%d %d %d %d", &newst.balls[0], &newst.balls[1], &newst.balls[2], &newst.balls[3]);
		printf_s("\n");
		fiz = newst.balls[0];
		mat = newst.balls[1];
		inf = newst.balls[2];
		him = newst.balls[3];
		newst.srball = (fiz + mat + inf + him) / 4;*/

		/*while (getchar() != '\n');
					gets_s(newst.FIO);
					newst.year = temp.year; newst.numgr = temp.numgr;
					newst.balls[0] = temp.balls[0]; newst.balls[1] = temp.balls[1];
					newst.balls[2] = temp.balls[2]; newst.balls[3] = temp.balls[3];
					fiz = newst.balls[0]; mat = newst.balls[1]; inf = newst.balls[2]; him = newst.balls[3];
					newst.srball = (fiz + mat + inf + him) / 4;*/